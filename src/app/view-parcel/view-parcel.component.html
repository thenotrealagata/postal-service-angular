<div class="content">
  <h2>View parcel</h2>
  @if (parcel) {
    <table style="width: 100%; margin-bottom: 2rem">
      <tr>
        <td class="font-weight-500">Sender</td>
        <td>{{ parcel.senderEmail }}</td>
      </tr>
      <tr>
        <td class="font-weight-500">Receiver</td>
        <td>{{ parcel.receiverEmail }}</td>
      </tr>
      <tr>
        <td class="font-weight-500">Size</td>
        <td>
          {{ ParcelSize[parcel.size] }}
        </td>
      </tr>
      <tr>
        <td class="font-weight-500">Pick-up point</td>
        <td>
          {{ parcel.endLocation.address }}
        </td>
      </tr>
      <tr>
        <td class="font-weight-500">Status</td>
        <td>
          <ng-container
            *ngTemplateOutlet="parcelStatus; context: { parcel: parcel }"
          ></ng-container>
        </td>
      </tr>
    </table>
    <nz-steps
      [nzCurrent]="getParcelState | curry: parcel"
      nzSize="small"
      style="margin-bottom: 1.5rem"
    >
      <nz-step
        nzTitle="Created"
        [nzDescription]="(parcel.createdAt | date) ?? ''"
      ></nz-step>
      <nz-step
        nzTitle="Placed"
        [nzDescription]="(parcel.placedAt | date) ?? ''"
      ></nz-step>
      <nz-step
        nzTitle="Arrived"
        [nzDescription]="(parcel.arrivedAt | date) ?? ''"
      ></nz-step>
    </nz-steps>
  } @else {
    <nz-icon nzType="loading" nzTheme="outline" /> Loading
  }

  @if (
    userEmail == parcel?.receiverEmail &&
    !parcel?.isFulfilled &&
    parcel?.arrivedAt
  ) {
    <button nz-button (click)="receive()">Receive parcel</button>
  }
  @if (userEmail == parcel?.senderEmail && !parcel?.placedAt) {
    <button nz-button (click)="post()">Post parcel</button>
  }
</div>

<ng-template #parcelStatus let-parcel="parcel">
  @if (parcel.isFulfilled) {
    <nz-icon nzType="checkCircle" nzTheme="outline" />
    Fulfilled
  } @else if (parcel.arrivedAt) {
    <nz-icon nzType="environment" nzTheme="outline" />
    Arrived
  } @else if (parcel.placedAt) {
    <nz-icon nzType="truck" nzTheme="outline" />
    On the way
  } @else {
    <nz-icon nzType="inbox" nzTheme="outline" />
    Not placed yet
  }
</ng-template>

<nz-modal
  [(nzVisible)]="isAccessCodeModalVisible"
  nzTitle="Input access code"
  (nzOnCancel)="closeAccessCodeModal()"
  (nzOnOk)="submitAccessCode()"
  [nzOkLoading]="getByAccessCodeLoading"
>
  <ng-container *nzModalContent>
    <p>
      To view a parcel that has been created by you or sent to you, input the
      access code you received in the confirmation e-mail and your e-mail
      address.
    </p>
    @if (accessCodeForm) {
      <form nz-form [formGroup]="accessCodeForm" nzLabelAlign="right">
        <nz-form-item>
          <nz-form-label nzRequired>E-mail</nz-form-label>
          <nz-form-control>
            <input
              nz-input
              placeholder="user@example.com"
              formControlName="email"
            />
          </nz-form-control>
        </nz-form-item>
        <nz-form-item>
          <nz-form-label nzRequired>Access code</nz-form-label>
          <nz-form-control>
            <input
              nz-input
              placeholder="Access code"
              formControlName="accessCode"
            />
          </nz-form-control>
        </nz-form-item>
      </form>
    }
  </ng-container>
</nz-modal>
